#!/bin/bash
echo ""
echo " ██      ██ ████████ ████     ██ ██     ██   ███████        ██"
echo "░██     ░██░░░░░░██ ░██░██   ░██░██    ░██  ██░░░░░██      ░██"
echo "░██     ░██     ██  ░██░░██  ░██░██    ░██ ██     ░░██     ░██"
echo "░██████████    ██   ░██ ░░██ ░██░██    ░██░██      ░██     ░██"
echo "░██░░░░░░██   ██    ░██  ░░██░██░██    ░██░██      ░██     ░██"
echo "░██     ░██  ██     ░██   ░░████░██    ░██░░██     ██  ██  ░██"
echo "░██     ░██ ████████░██    ░░███░░███████  ░░███████  ░░█████ "
echo "░░      ░░ ░░░░░░░░ ░░      ░░░  ░░░░░░░    ░░░░░░░    ░░░░░  "
echo ""
#update-sources-ubuntu
sed -i 's/http\:\/\/il.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/us.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/cn.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/fr.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/in.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/np.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/fi.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/th.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/ru.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/md.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/ch.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/se.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/no.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/nl.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/am.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/dk.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/is.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/ua.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/ge.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/nz.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/cr.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/hk.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/gb.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/us-east-1.ec2.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/cz.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/id.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/es.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/my.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/us-west-2.ec2.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/za.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/sk.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/ph.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/hr.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/us-east-1a.clouds.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/eu-west-2.ec2.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/gl.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/jp.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/jo.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/pt.archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g' /etc/apt/sources.list
sed -i 's/http\:\/\/archive.ubuntu.com/https\:\/\/mirrors.aliyun.com/g'    /etc/apt/sources.list
sed -i 's/http\:\/\/security.ubuntu.com/https\:\/\/mirrors.aliyun.com/g'   /etc/apt/sources.list
apt-get update
for pkg in "net-tools make flex g++ clang libmysqlclient-dev libmysql++-dev php-fpm nginx mysql-server php-mysql  php-common php-gd php-zip fp-compiler openjdk-11-jdk mono-devel php-mbstring php-xml php-curl php-intl php-xmlrpc php-soap subversion"
do
    while ! apt-get install -y $pkg 
    do
        echo "Network fail, retry... you might want to change another apt source for install"
    done
done
reset
echo ""
echo " ██      ██ ████████ ████     ██ ██     ██   ███████        ██"
echo "░██     ░██░░░░░░██ ░██░██   ░██░██    ░██  ██░░░░░██      ░██"
echo "░██     ░██     ██  ░██░░██  ░██░██    ░██ ██     ░░██     ░██"
echo "░██████████    ██   ░██ ░░██ ░██░██    ░██░██      ░██     ░██"
echo "░██░░░░░░██   ██    ░██  ░░██░██░██    ░██░██      ░██     ░██"
echo "░██     ░██  ██     ░██   ░░████░██    ░██░░██     ██  ██  ░██"
echo "░██     ░██ ████████░██    ░░███░░███████  ░░███████  ░░█████ "
echo "░░      ░░ ░░░░░░░░ ░░      ░░░  ░░░░░░░    ░░░░░░░    ░░░░░  "
echo ""
/usr/sbin/useradd -m -u 1536 judge
cp -R HZNUOJ /home/judge/
cd /home/judge/

USER=`cat /etc/mysql/debian.cnf |grep user|head -1|awk  '{print $3}'`
PASSWORD=`cat /etc/mysql/debian.cnf |grep password|head -1|awk  '{print $3}'`
CPU=`grep "cpu cores" /proc/cpuinfo |head -1|awk '{print $4}'`

mkdir etc data log backup
mkdir -p /home/judge/HZNUOJ/web/OJ/upload

cp HZNUOJ/judger/install/java0.policy  /home/judge/etc
cp HZNUOJ/judger/install/judge.conf  /home/judge/etc
chmod +x HZNUOJ/judger/install/ans2out
chmod +x HZNUOJ/judger/install/hustoj

mkdir run0 run1 run2 run3
chown judge run0 run1 run2 run3
sed -i "s/OJ_USER_NAME=root/OJ_USER_NAME=$USER/g" etc/judge.conf
sed -i "s/OJ_PASSWORD=root/OJ_PASSWORD=$PASSWORD/g" etc/judge.conf
sed -i "s/OJ_COMPILE_CHROOT=1/OJ_COMPILE_CHROOT=0/g" etc/judge.conf
sed -i "s/OJ_RUNNING=1/OJ_RUNNING=$CPU/g" etc/judge.conf

chmod 700 backup
chmod 700 etc/judge.conf

sed -i "s/DB_USER[[:space:]]*=[[:space:]]*\"root\"/DB_USER=\"$USER\"/g" HZNUOJ/web/OJ/include/static.php
sed -i "s/DB_PASS[[:space:]]*=[[:space:]]*\"root\"/DB_PASS=\"$PASSWORD\"/g" HZNUOJ/web/OJ/include/static.php

mkdir -p /home/judge/data/1000
pushd /home/judge/data/1000
    echo "1 2" > sample0.in
    echo "3" > sample0.out
    echo "6 10" > test0.in
    echo "16" > test0.out
    echo "6 9" > test1.in
    echo "15" > test1.out
    echo "0 0" > test2.in
    echo "0" > test2.out
popd
chmod 700 HZNUOJ/web/OJ/include/static.php
chown -R www-data HZNUOJ/web/
chown www-data HZNUOJ/web/OJ/upload data
if grep "client_max_body_size" /etc/nginx/nginx.conf ; then 
    echo "client_max_body_size already added" ;
else
    sed -i "s:include /etc/nginx/mime.types;:client_max_body_size    80m;\n\tinclude /etc/nginx/mime.types;:g" /etc/nginx/nginx.conf
fi

mysql -h localhost -u$USER -p$PASSWORD < HZNUOJ/judger/install/db.sql

if grep "added by hustoj" /etc/nginx/sites-enabled/default ; then
    echo "default site modified!"
else
    echo "modify the default site"
    sed -i "s#root /var/www/html;#root /home/judge/HZNUOJ/web/OJ;#g" /etc/nginx/sites-enabled/default
    sed -i "s:index index.html:index index.php:g" /etc/nginx/sites-enabled/default
    sed -i "s:#location ~ \\\.php\\$:location ~ \\\.php\\$:g" /etc/nginx/sites-enabled/default
    sed -i "s:#\tinclude snippets:\tinclude snippets:g" /etc/nginx/sites-enabled/default
    sed -i "s|#\tfastcgi_pass unix|\tfastcgi_pass unix|g" /etc/nginx/sites-enabled/default
    sed -i "s:}#added by hustoj::g" /etc/nginx/sites-enabled/default
    sed -i "s:php7.0:php7.2:g" /etc/nginx/sites-enabled/default
    sed -i "s|# deny access to .htaccess files|}#added by hustoj\n\n\n\t# deny access to .htaccess files|g" /etc/nginx/sites-enabled/default
fi
/etc/init.d/nginx restart
sed -i "s/post_max_size = 8M/post_max_size = 80M/g" /etc/php/7.2/fpm/php.ini
sed -i "s/upload_max_filesize = 2M/upload_max_filesize = 80M/g" /etc/php/7.2/fpm/php.ini
sed -i 's/;request_terminate_timeout = 0/request_terminate_timeout = 128/g' `find /etc/php -name www.conf`
sed -i 's/pm.max_children = 5/pm.max_children = 200/g' `find /etc/php -name www.conf`
 
COMPENSATION=`grep 'mips' /proc/cpuinfo|head -1|awk -F: '{printf("%.2f",$2/5000)}'`
sed -i "s/OJ_CPU_COMPENSATION=1.0/OJ_CPU_COMPENSATION=$COMPENSATION/g" etc/judge.conf

/etc/init.d/php7.2-fpm restart
service php7.2-fpm restart

cd HZNUOJ/judger/core
chmod +x ./make.sh
./make.sh
if grep "/usr/bin/judged" /etc/rc.local ; then
    echo "auto start judged added!"
else
    sed -i "s/exit 0//g" /etc/rc.local
    echo "/usr/bin/judged" >> /etc/rc.local
    echo "exit 0" >> /etc/rc.local
    echo "add auto start judged."
fi

ln -s /usr/bin/mcs /usr/bin/gmcs

/usr/bin/judged
cp /home/judge/HZNUOJ/judger/install/hustoj /etc/init.d/hustoj
update-rc.d hustoj defaults
systemctl enable hustoj
systemctl enable nginx
systemctl enable mysql
systemctl enable php7.2-fpm
systemctl enable judged

mkdir /var/log/hustoj/
chown www-data -R /var/log/hustoj/

reset
echo ""
echo " ██      ██ ████████ ████     ██ ██     ██   ███████        ██"
echo "░██     ░██░░░░░░██ ░██░██   ░██░██    ░██  ██░░░░░██      ░██"
echo "░██     ░██     ██  ░██░░██  ░██░██    ░██ ██     ░░██     ░██"
echo "░██████████    ██   ░██ ░░██ ░██░██    ░██░██      ░██     ░██"
echo "░██░░░░░░██   ██    ░██  ░░██░██░██    ░██░██      ░██     ░██"
echo "░██     ░██  ██     ░██   ░░████░██    ░██░░██     ██  ██  ░██"
echo "░██     ░██ ████████░██    ░░███░░███████  ░░███████  ░░█████ "
echo "░░      ░░ ░░░░░░░░ ░░      ░░░  ░░░░░░░    ░░░░░░░    ░░░░░  "
echo ""
echo "OJ Configuration:"
echo ""
printf "1-Please input OJ's name, press Enter for default name(argument:\$OJ_NAME): "
read ojname
if test "$ojname" != ""
then
    sed -i "s/OJ_NAME=\"HZNUOJ\"/OJ_NAME=\"$ojname\"/g" /home/judge/HZNUOJ/web/OJ/include/static.php
fi
echo ""
echo "2-Please select the UI language.(argument:\$OJ_LANG)"
echo "  1) Chinese"
echo "  2) English"
temp=0
while test $temp != 1 -a $temp != 2
do
    printf "#? "
    read temp
done
if test $temp = 1
then
    sed -i "s/OJ_LANG=\"en\"/OJ_LANG=\"cn\"/g" /home/judge/HZNUOJ/web/OJ/include/static.php
else
    sed -i "s/OJ_LANG=\"cn\"/OJ_LANG=\"en\"/g" /home/judge/HZNUOJ/web/OJ/include/static.php
fi
echo ""
echo "3-Please select running mode.(argument:OJ_OI_MODE)"
echo "  1)  OI Mode (Middle school)"
echo "  2) ACM Mode (University)"
temp=0
while test $temp != 1 -a $temp != 2
do
    printf "#? "
    read temp
done
if test $temp = 1
then
    sed -i "s/OJ_OI_MODE=0/OJ_OI_MODE=1/g" /home/judge/etc/judge.conf
else
    sed -i "s/OJ_OI_MODE=1/OJ_OI_MODE=0/g" /home/judge/etc/judge.conf
fi
echo ""
echo "4-Please select trun on/off the code share mode.(argument:\$OJ_AUTO_SHARE)"
echo "  1) Trun on  (All of users are able to view all submissions after solving this problem.)"
echo "  2) Trun off (Only administrators are able to view all submissions.)"
temp=0
while test $temp != 1 -a $temp != 2
do
    printf "#? "
    read temp
done
if test $temp = 2
then
    sed -i "s/OJ_AUTO_SHARE=true/OJ_AUTO_SHARE=false/g" /home/judge/HZNUOJ/web/OJ/include/static.php
else
    sed -i "s/OJ_AUTO_SHARE=false/OJ_AUTO_SHARE=true/g" /home/judge/HZNUOJ/web/OJ/include/static.php
fi
echo ""
echo "5-Please select trun on/off show the WA/CE information in reinfo/ceinfo page.(argument:\$OJ_SHOW_DIFF)"
echo "1) Trun on  (All of users are able to view the WA/CE information of their own code.)"
echo "2) Trun off (Only administrators are able to view the WA/CE information.)"
temp=0
while test $temp != 1 -a $temp != 2
do
    printf "#? "
    read temp
done
if test $temp = 2
then
    sed -i "s/OJ_SHOW_DIFF=true/OJ_SHOW_DIFF=false/g" /home/judge/HZNUOJ/web/OJ/include/static.php
else
    sed -i "s/OJ_SHOW_DIFF=false/OJ_SHOW_DIFF=true/g" /home/judge/HZNUOJ/web/OJ/include/static.php
fi
echo ""
echo "6-Please select trun on/off source code similarity detection.(argument:\$OJ_SIM, OJ_SIM_ENABLE)"
echo "1) Trun on"
echo "2) Trun off"
temp=0
while test $temp != 1 -a $temp != 2
do
    printf "#? "
    read temp
done
if test $temp = 2
then
    sed -i "s/OJ_SIM=true/OJ_SIM=false/g" /home/judge/HZNUOJ/web/OJ/include/static.php
    sed -i "s/OJ_SIM_ENABLE=1/OJ_SIM_ENABLE=0/g" /home/judge/etc/judge.conf
else
    sed -i "s/OJ_SIM=false/OJ_SIM=true/g" /home/judge/HZNUOJ/web/OJ/include/static.php
    sed -i "s/OJ_SIM_ENABLE=0/OJ_SIM_ENABLE=1/g" /home/judge/etc/judge.conf
fi
echo ""
echo "7-Please select trun on/off show the contest's solution in status page.(argument:\$OJ_show_contestSolutionInStatus)"
echo "1) Trun on  (contest's solution will be show in status page and contest-status page.)"
echo "2) Trun off (contest's solution will be show in contest-status page only.)"
temp=0
while test $temp != 1 -a $temp != 2
do
    printf "#? "
    read temp
done
if test $temp = 1
then
    sed -i "s/OJ_show_contestSolutionInStatus=false/OJ_show_contestSolutionInStatus=true/g" /home/judge/HZNUOJ/web/OJ/include/static.php
else
    sed -i "s/OJ_show_contestSolutionInStatus=true/OJ_show_contestSolutionInStatus=false/g" /home/judge/HZNUOJ/web/OJ/include/static.php
fi
echo ""
echo "Install HZNUOJ successfully!"
echo "Remember your database account for HZNUOJ:"
echo "username:$USER"
echo "password:$PASSWORD"
